<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../paper-progress/paper-progress.html">

<link rel="import" href="../warp10-tiles/warp10-dashboard-styles.html">
<link rel="import" href="../warp10-tiles/warp10-dashboard-tile.html">
<link rel="import" href="../warp10-tiles/warp10-tile-num-behavior.html">

<dom-module is="warp10-display-gauge">
  <template>    
    <style include="warp10-dashboard-styles">
      :host {
        display: inline-block;
      }
      .vertical {
        height: 100%;
        width: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-around-justified);
      }

      paper-progress {
        --paper-progress-active-color: var(--color);
        --paper-progress-secondary-color: var(--sndcolor);
        --paper-progress-height: var(--progressHeight);
        width: var(--progressWidth);
        height: var(--progressHeight);
      }
      paper-progress.outside_bounds {
        -webkit-box-shadow: 0px 0px 10px 5px rgba(255,0,0,1);
        -moz-box-shadow: 0px 0px 10px 5px rgba(255,0,0,1);
        box-shadow: 0px 0px 10px 5px rgba(255,0,0,1);
      }

      #value {
        font-size: 5em;
      }
    </style>
    <warp10-dashboard-tile id='tile'
      tile="{{tile}}"  width="{{width}}" height="{{height}}"
      bg-color="{{bgColor}}" fg-color="{{fgColor}}" description="[[description]]"
    >
      <div class="card-content">
        <div class="main-content">  
   
          <div class="vertical">

          <div class="value" id="value">{{_getDisplayValue(data.value)}}</div>

            <paper-progress id="progress" value="[[data.value]]" secondary-progress="{{data.secondaryValue}}" 
                min="{{data.min}}" max="{{data.max}}" class$="[[_outsideBounds]]">
            </paper-progress>
          </div>
        </div>
        <div class="label">[[label]]</div>
      </div>     
    </warp10-dashboard-tile>      
  </template>
  <script>
    Polymer({
      // Element identity
      is:"warp10-display-gauge",
      
      behaviors: [ Warp10TileNumericBehavior ],

      // Properties
      properties: {
        
        /**
         * The value to display
         */
        data: {
          type: Object,
          value: function(){
            return {
              value: 0,
              secondaryValue: 0,
              max: 100,
              min: 0,
              color: "#0F9D58",
              secondaryColor: "#B7E1CD"
            };
          }
        },

        /**
        *
        */
        _isAttached: {
          type: Boolean,
          value: false
        }, 

        _outsideBounds: {
          type: String,
          computed: "_isOutsideBounds(data)"
        }      

      },
      
      // Observers
      observers: [
        '_colorChanged(data.color)',
        '_secondaryColorChanged(data.secondaryColor)',
        "_textWidth(data.value, width, _isAttached)"
      ],
      
      // Lifecycle methods
      attached: function() {     
        this._initializeTile();
        this._isAttached = true;  
      },

      // Observers
      _colorChanged: function() {
        if (!this.isAttached) {
          return;
        }        
        this.customStyle['--color'] = this.gaugeColor;   
      },
      _secondaryColorChanged: function() {
        if (!this.isAttached) {
          return;
        }         
        this.customStyle['--sndcolor'] = this.sndGaugeColor;
      },
       _isOutsideBounds: function() {
         //console.debug("[warp10-display-gauge] _isOutsideBounds ",this.data.value, this.data.max, this.data.min)
        if (this.data.value > this.data.max || this.data.value < this.data.min) {
          return "outside_bounds";
        }
        return "";
       },
      _textWidth: function() {
        if (!this.width ||!this._isAttached) {
          return;
        }
        console.debug("[warp10-display-gauge] _textWidth",  this.$.value.clientWidth, this.width);
        if ( this.$.value.clientWidth >= this.width) {
          var currentFontSize = parseFloat(getComputedStyle(this.$.value).fontSize.replace("px",""));
          var newFontSize = currentFontSize * 0.9 + "px";
          this.$.value.style.fontSize = newFontSize;
          console.debug("[warp10-display-num] _textWidth - value.style", newFontSize);
          this._textWidth();
        }
      },      
      // Other methods
      _initializeTile: function(){
        var progressWidth = 120;
        var progressHeight = 8;
        this.customStyle['--color'] = this.gaugeColor;
        this.customStyle['--sndcolor'] = this.sndGaugeColor;
        
        
        // console.debug("[warp10-display-gauge] _initialize - width: "+ this.width+" and usefulWidth: "+ this.usefulWidth);
        // console.debug("[warp10-display-gauge] _initialize - height: "+ this.height+" and usefulHeight: "+ this.usefulHeight);
        
        if(this.usefulWidth > 200 || this.usefulHeight > 200) {
          progressHeight = 12;
        }

        if(this.usefulWidth > 260) {
          progressWidth = this.usefulWidth - 40;
        }

        if(this.usefulWidth > 260 && this.usefulHeight > 260) {
          progressHeight = 30;
        }

        this.customStyle['--progressHeight'] = progressHeight.toString() + "px";
        this.customStyle['--progressWidth'] = progressWidth.toString() + "px";

        this.updateStyles();
      },
      
    });
  </script>
</dom-module>