<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../warp10-tiles/warp10-dashboard-styles.html">
<link rel="import" href="../warp10-tiles/warp10-dashboard-tile.html">
<link rel="import" href="../warp10-tiles/warp10-display-behavior.html">

<dom-module is="warp10-display-num">
  <template>    
    <style include="warp10-dashboard-styles">
      :host {
        display: inline-block;
      }
    </style>
    <warp10-dashboard-tile 
        tile="{{tile}}" description="[[description]]"
        width="{{width}}" height="{{height}}"
        bg-color="{{bgColor}}" fg-color="{{fgColor}}">
      <div class="card-content">
        <div class="main-content">        
          <div id="value" class="value">[[_stringValue]]</div>
        </div>
        <div class="label">[[label]]</div>
      </div>     
    </warp10-dashboard-tile>  
  </template>
  <script>
    Polymer({
      // Element identity
      is:"warp10-display-num",
      
      behaviors: [ Warp10DisplayBehavior ],
      
      // Properties
      properties: {        
          
            
        /**
         * The data to display
         */
        data: {
          type: Number,
          value: 0
        },
        /**
         * The number of decimal digits to show, default all
         */
        precision: {
          type: Number,
          value: -1
        },
        /**
         *
         */
        _stringValue: {
          type: String,
          computed: "_getValueString(data, precision)",
          observer: "_textWidth"
        },

        _valueFontSize: {
          type: Number,
          value: 1
        }, 

        _isAttached: {
          type: Boolean,
          value: false
        },
      },
      observers: [
        "_textWidth(_stringValue, width, _isAttached)"
      ],

      // Lifecycle
      attached: function() {
        this._isAttached = true;
      },
      
      // Computed properties' methods
      _getValueString: function() {
        var data = this.data;
        if (this.precision >= 0) {
          data = Math.floor(data*Math.pow(10,this.precision))/Math.pow(10,this.precision);
        } 
        var dataString = data.toString().split('.');
        var result = dataString[0].replace(/(\d)+(\d{3})+/g, "$1 $2");
        if (dataString.length >0) {
          result += "."+ dataString[1];
        }
        return result;
      },

      _textWidth: function() {
        if (!this.width ||!this._isAttached) {
          return;
        }
        console.debug("[warp10-display-num] _textWidth",  this.$.value.clientWidth, this.width);
        if ( this.$.value.clientWidth >= this.width) {
          var currentFontSize = parseFloat(getComputedStyle(this.$.value).fontSize.replace("px",""));
          var newFontSize = currentFontSize * 0.9 + "px";
          this.$.value.style.fontSize = newFontSize;
          console.debug("[warp10-display-num] _textWidth - value.style", newFontSize);
          this._textWidth();
        }
      }
      
    });
  </script>
</dom-module>